apiVersion: v1
kind: ConfigMap
metadata:
  name: rke2-install-script-{{ .Release.Name }}
  namespace: default
data:
  install.sh: |
    #!/bin/bash
    set -e
    apt update && apt install -y curl
    curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION={{ .Values.rke2.version }} sh -
    mkdir -p /etc/rancher/rke2
    cp /etc/rancher/rke2-config-{{ .Release.Name }}/config.yaml /etc/rancher/rke2/config.yaml
    systemctl enable rke2-server.service
    systemctl start rke2-server.service
    {{ if eq (add .Release.Revision 1) 1 }}
    # Install Kube-VIP on first node only
    curl -s https://kube-vip.io/manifests/rbac.yaml > /var/lib/rancher/rke2/server/manifests/kube-vip-rbac.yaml
    crictl pull docker.io/plndr/kube-vip:{{ .Values.kubeVip.version }}
    ctr --namespace k8s.io run --rm --net-host docker.io/plndr/kube-vip:{{ .Values.kubeVip.version }} vip /kube-vip manifest daemonset \
      --arp \
      --interface {{ .Values.kubeVip.interface }} \
      --address {{ .Values.kubeVip.vip }} \
      --controlplane \
      --leaderElection \
      --taint \
      --services \
      --inCluster > /var/lib/rancher/rke2/server/manifests/kube-vip.yaml
    # Install Helm and Cert-Manager
    curl -#L https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    helm repo add jetstack https://charts.jetstack.io --force-update
    helm upgrade -i cert-manager jetstack/cert-manager -n cert-manager --create-namespace --set crds.enabled=true
    {{ end }}
    # Symlink kubectl
    ln -s $(find /var/lib/rancher/rke2/data/ -name kubectl) /usr/local/bin/kubectl
    echo "export KUBECONFIG=/etc/rancher/rke2/rke2.yaml" >> /root/.bashrc
    echo "PATH=$PATH:/usr/local/bin/:/var/lib/rancher/rke2/bin/" >> /root/.bashrc
    source /root/.bashrc
